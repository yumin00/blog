---
title: "Service DB 에 분석 쿼리를 실행하면 어떤 문제가 발생할까?"
date: 2024-07-02T18:57:21+09:00
draft: true
categories :
- DataBase
- DataEngineering
---

Service DB는 사용자가 서비스를 사용하며 데이터를 읽거나 쓸 때 사용되는 DB이다. 서비스를 운영하다 보면 사용자의 데이터를 분석해야하는 상황이 발생한다.
예를 들어 온라인커머스 서비스를 운영하고 있다고 가정해보자. 그러면 온라인MD는 각 상품의 매출에 대한 지표를 확인하고 싶을 수 있다.

`sales` 라는 매출에 관련된 table이 있다면 온라인 MD 에게 상품의 매출에 대한 데이터를 제공해줄 때, 가장 간단한 방법은 `sales` table에 바로 쿼리를 작성하여 데이터를 제공해주는 것이다.
하지만 이때 발생하는 문제는 무엇일까?

오늘은 Service DB에 분석을 위한 쿼리를 실행했을 때 발생할 수 있는 문제와 해결할 수 있는 방법에 대해 생각해보고자 한다.

어떤 문제점이 발생할 수 있을지에 대해 알아보기 전, 먼저 어떤 지표를 확인하면 좋을지에 대해 생각해보았다.

### CPU
높은 CPU 사용률은 DB 서버에 많은 계산 작업을 수행하고 있다는 신호이다.

### Memory
메모리가 부족하다면 디스크 I/O가 증가하여 성능이 저할 될 수 있다.

### 디스크 I/O
쿼리가 많은 데이터를 읽거나 쓸 때, 디스크 I/O가 증가한다. 디스크 대기 시간이 길어지면 성능 저하가 발생할 수 있다.

### 쿼리 응답 시간
응답 시간이 길어지면, 성능 문제를 의심할 수 있다.

### 동시 연결 수
동시 연결 수가 많아지면 자원 경합이 발생할 수 있다.

### 락 대기 시간
쿼리 실행 중 락이 발생하여 다른 트랜잭션이 대기하는 시간을 모니터링해야 한다. 락 경합이 심하면 성능 저하가 발생할 수 있다.

현재 사내에서 사용하고 있는 DB는 PostgreSQL인데, 
PostgreSQL는 데이터를 읽을 때, 일반적으로 **공유 잠금 (shared lock)**이 설정되어 있기 때문에 여러 트랜잭션이 동시에 같은 행을 동시에 읽을 수 있다.
따라서, 락 대기 시간에 대한 지표는 확인하지 않아도 될 것 같다고 생각한다!

# 문제점
## 성능 저하
서비스 DB에서 데이터 분석을 위한 쿼리를 지속적으로 실행하면, 성능 저하 문제가 발생할 수 있다.